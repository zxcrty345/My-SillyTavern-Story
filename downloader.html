<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å°å‰§åœºåº“ - æ•°æ®åŒ…ä¸‹è½½å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- æ ·å¼å¯ä»¥è‡ªè¡Œç¾åŒ– -->
</head>
<body>
    <h1>å°å‰§åœºåº“ - æœ€æ–°æ•°æ®åŒ…ä¸‹è½½å™¨</h1>
    <button id="downloadBtn">ç”Ÿæˆå¹¶ä¸‹è½½æœ€æ–°æ•°æ®åŒ… (data.zip)</button>
    <div id="log" style="white-space: pre-wrap; background: #eee; margin-top: 10px; padding: 5px;"></div>
    <script>
        const SERVER_URL = "http://1.92.122.106"; // æ‚¨çš„åœ¨çº¿æœåŠ¡å™¨åœ°å€
        const downloadBtn = document.getElementById('downloadBtn');
        const logDiv = document.getElementById('log');

        function log(message) { logDiv.innerHTML += message + '\\n'; }

        downloadBtn.addEventListener('click', async () => {
            downloadBtn.disabled = true;
            logDiv.innerHTML = '';
            log('ğŸš€ å¼€å§‹ç”Ÿæˆ...');
            try {
                const zip = new JSZip();
                const dataFolder = zip.folder("data");
                const storiesFolder = dataFolder.folder("stories");

                log('æ­£åœ¨è·å–ç´¢å¼• index.json...');
                const indexResponse = await fetch(`${SERVER_URL}/index.json?t=${Date.now()}`);
                const indexContent = await indexResponse.text();
                const storiesIndex = JSON.parse(indexContent);
                dataFolder.file("index.json", indexContent);
                log(`âœ… ç´¢å¼•è·å–æˆåŠŸï¼Œå…± ${storiesIndex.length} ä¸ªå‰§æœ¬ã€‚`);

                log('æ­£åœ¨æ‰¹é‡è·å–å‰§æœ¬å†…å®¹...');
                const storyPromises = storiesIndex.map(story =>
                    fetch(`${SERVER_URL}/stories/${story.id}.json?t=${Date.now()}`)
                        .then(res => res.text())
                        .then(content => {
                            storiesFolder.file(`${story.id}.json`, content);
                            log(`  - å·²æ‰“åŒ…: ${story.title}`);
                        })
                );
                await Promise.all(storyPromises);
                log('âœ… æ‰€æœ‰å‰§æœ¬æ‰“åŒ…å®Œæˆï¼');

                const zipContent = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipContent);
                link.download = `SillyTavern-Stories-Data.zip`;
                link.click();
                URL.revokeObjectURL(link.href);
                log('ğŸ‰ ä¸‹è½½å·²å¼€å§‹ï¼');

            } catch (error) {
                log(`âŒ å‘ç”Ÿé”™è¯¯: ${error.message}`);
            } finally {
                downloadBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
