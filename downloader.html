<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>小剧场库 - 数据包下载器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 样式可以自行美化 -->
</head>
<body>
    <h1>小剧场库 - 最新数据包下载器</h1>
    <button id="downloadBtn">生成并下载最新数据包 (data.zip)</button>
    <div id="log" style="white-space: pre-wrap; background: #eee; margin-top: 10px; padding: 5px;"></div>
    <script>
        const SERVER_URL = "http://1.92.122.106"; // 您的在线服务器地址
        const downloadBtn = document.getElementById('downloadBtn');
        const logDiv = document.getElementById('log');

        function log(message) { logDiv.innerHTML += message + '\\n'; }

        downloadBtn.addEventListener('click', async () => {
            downloadBtn.disabled = true;
            logDiv.innerHTML = '';
            log('🚀 开始生成...');
            try {
                const zip = new JSZip();
                const dataFolder = zip.folder("data");
                const storiesFolder = dataFolder.folder("stories");

                log('正在获取索引 index.json...');
                const indexResponse = await fetch(`${SERVER_URL}/index.json?t=${Date.now()}`);
                const indexContent = await indexResponse.text();
                const storiesIndex = JSON.parse(indexContent);
                dataFolder.file("index.json", indexContent);
                log(`✅ 索引获取成功，共 ${storiesIndex.length} 个剧本。`);

                log('正在批量获取剧本内容...');
                const storyPromises = storiesIndex.map(story =>
                    fetch(`${SERVER_URL}/stories/${story.id}.json?t=${Date.now()}`)
                        .then(res => res.text())
                        .then(content => {
                            storiesFolder.file(`${story.id}.json`, content);
                            log(`  - 已打包: ${story.title}`);
                        })
                );
                await Promise.all(storyPromises);
                log('✅ 所有剧本打包完成！');

                const zipContent = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipContent);
                link.download = `SillyTavern-Stories-Data.zip`;
                link.click();
                URL.revokeObjectURL(link.href);
                log('🎉 下载已开始！');

            } catch (error) {
                log(`❌ 发生错误: ${error.message}`);
            } finally {
                downloadBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
